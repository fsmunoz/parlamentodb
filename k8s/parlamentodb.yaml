apiVersion: v1
kind: Namespace
metadata:
  name: parlamentodb
---
# ===============================
# .ENV ENVIRONMENT FILE AS CONFIGMAP
# ===============================
apiVersion: v1
kind: ConfigMap
metadata:
  name: parlamentodb-env
  namespace: parlamentodb
data:
  .env: |
    # Paste the exact content of your .env file here.
    # Example:
    # DATABASE_URL=postgres://...
---
# ===============================
# DEPLOYMENT
# ===============================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: parlamentodb
  namespace: parlamentodb
spec:
  replicas: 1
  selector:
    matchLabels:
      app: parlamentodb
  template:
    metadata:
      labels:
        app: parlamentodb
    spec:
      containers:
        - name: api
          image: parlamentodb:latest   # <- Replace with your actual image or registry tag
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000

          # ===== ENV VARS =====
          env:
            - name: PORT
              value: "8000"
            - name: LOG_LEVEL
              value: "INFO"
            - name: DEFAULT_LIMIT
              value: "50"
            - name: MAX_LIMIT
              value: "500"

          # ===== LOAD .ENV FILE FROM CONFIGMAP =====
          envFrom:
            - configMapRef:
                name: parlamentodb-env

          # ===== HEALTHCHECK (docker → k8s probes) =====
          readinessProbe:
            exec:
              command:
                - python
                - -c
                - "import httpx; httpx.get('http://localhost:8000/health', timeout=2)"
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          livenessProbe:
            exec:
              command:
                - python
                - -c
                - "import httpx; httpx.get('http://localhost:8000/health', timeout=2)"
            initialDelaySeconds: 10
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3

          # ===== VOLUME MOUNTS =====
          volumeMounts:
            - name: data-volume
              mountPath: /app/data
              readOnly: true
            - name: app-volume
              mountPath: /app/app
              readOnly: true

      # ===== VOLUMES =====
      volumes:
        - name: data-volume
          hostPath:
            path: /home/fsmunoz/parlamentodb/data     # <— change this to actual host location
            type: Directory
        - name: app-volume
          hostPath:
            path: /home/fsmunoz/parlamentodb/app      # <— change this to actual host location
            type: Directory
---
# ===============================
# SERVICE (Traefik routes to this)
# ===============================
apiVersion: v1
kind: Service
metadata:
  name: parlamentodb
  namespace: parlamentodb
spec:
  selector:
    app: parlamentodb
  ports:
    - name: http
      port: 8000
      targetPort: 8000
